<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>PP3</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="author" content="Lucas Penteado Sacchi"> <!-- RA 726562 -->
		<meta name="author" content="Sofia de Almeida Machado da Silveira"> <!-- RA 726589 -->

		<style>
			html, body, canvas {
				padding: 0px;
				margin: 0px 0px;
				width: 100% !important;
				height: 100%;
			}
			#screenshot {
				position: absolute;
				margin: 15px 5px;
			}
			#comandos {
				position: absolute;
				bottom: 0px;
				margin: 10px;
				font-size: 20px;
			}
		</style>
	</head>
	<body>
		<canvas id="c"></canvas>
		<button id="screenshot" type="button">Armazenar em uma imagem</button>
		<div id="comandos">
			Botão esquerdo: gira a câmera no mesmo eixo<br>
			Botão direito: altera a posição da câmera
		</div>

		<script type="module">

			// Imports
			import * as THREE from './js/three.module.js';
			import { OrbitControls } from './js/OrbitControls.js';
			import { FBXLoader } from './js/FBXLoader.js';

			function main() {
				let camera, scene, renderer, loader, controls, m3, m4;
				const canvas = document.querySelector('#c');
				
				// Render
				renderer = new THREE.WebGLRenderer({canvas, preserveDrawingBuffer: true});
				renderer.setSize(window.innerWidth, window.innerHeight);
				document.body.appendChild(renderer.domElement);
				renderer.setClearColor(0x7ec0ee);

				// Scene
				scene = new THREE.Scene();

				// Camera
				const fov = 75;
				const aspect = window.innerWidth / window.innerHeight;
				const near = 0.1;
				const far = 1000;
				camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
				camera.position.z = 25;

				// OrbitControl (Camera para visualizar o cenário)
				controls = new OrbitControls(camera, renderer.domElement);
				controls.target.set(0, 0, -5);
				controls.update();

				// Material
				var material1 = new THREE.MeshBasicMaterial({color: 0x996600, wireframe:false});
				var material2 = new THREE.MeshBasicMaterial({color: 0x664400, wireframe:false});

				// Carrega a imagem do shiba
				loader = new FBXLoader();
				loader.load('./obj/shiba/shiba.FBX', function (object) {
					object.traverse(function (child) {
						if (child instanceof THREE.Mesh) {
							child.material = material1;
						}
					});

					// Redimensionamento
					m3 = new THREE.Matrix3().set(
						8, 0, 0,
						0, 8, 0,
						0, 0, 8
					);
					object.scale.applyMatrix3(m3);

					// Posicionamento
					m4 = new THREE.Matrix4().set(
						1, 0, 0, -6,
						0, 1, 0, -2,
						0, 0, 1, 0,
						0, 0, 0, 1
					);
					object.position.setFromMatrixPosition(m4);

					// Rotação
					m4 = new THREE.Matrix4().set(
						1, 0, 0, 0,
						0, 1, 0, 0,
						0, 0, 1, 0,
						0, 0, 0, 1
					);
					object.setRotationFromMatrix(m4);

					scene.add(object);
				});

				// Carrega a imagem do baby shiba
				loader = new FBXLoader();
				loader.load('./obj/baby_shiba/baby_shiba.fbx', function (object) {
					object.traverse(function (child) {
						if (child instanceof THREE.Mesh) {
							child.material = material2;
						}
					});

					// Redimensionamento
					m3 = new THREE.Matrix3().set(
						10, 0, 0,
						0, 10, 0,
						0, 0, 10
					);
					object.scale.applyMatrix3(m3);

					// Posicionamento
					m4 = new THREE.Matrix4().set(
						1, 0, 0, 6,
						0, 1, 0, 0,
						0, 0, 1, 0,
						0, 0, 0, 1
					);
					object.position.setFromMatrixPosition(m4);

					// Rotação
					m4 = new THREE.Matrix4().set(
						1, 0, 0, 0,
						0, Math.cos(-Math.PI / 2), -Math.sin(-Math.PI / 2), 0,
						0, Math.sin(-Math.PI / 2), Math.cos(-Math.PI / 2), 0,
						0, 0, 0, 1
					);
					object.setRotationFromMatrix(m4);

					scene.add(object);
				});

				// Atualiza as dimensões da cena
				window.addEventListener('resize', function () {
					const canvas = renderer.domElement;
					var width = window.innerWidth;
					var height = window.innerHeight;
					renderer.setSize(width, height);
					camera.aspect = width / height;
					// camera.updateProjectionMatrix();
				});

				// Armazenar o frame em uma imagem
				const elem = document.querySelector('#screenshot');
				elem.addEventListener('click', () => {
					canvas.toBlob((blob) => {
						saveBlob(blob, `img-${canvas.width}x${canvas.height}.png`);
					});
				});
				
				const saveBlob = (function() {
					const a = document.createElement('a');
					document.body.appendChild(a);
					a.style.display = 'none';
					return function saveData(blob, fileName) {
						const url = window.URL.createObjectURL(blob);
						a.href = url;
						a.download = fileName;
						a.click();
					};
				}());

				// Anima o cenário
				function animate() {
					requestAnimationFrame(animate);
					renderer.render(scene, camera);
				}
				animate();
			}
			// Começa tudo
			main();

		</script>
	</body>
</html>
